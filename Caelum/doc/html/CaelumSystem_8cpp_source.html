<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>Caelum: main/src/CaelumSystem.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.9 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>main/src/CaelumSystem.cpp</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">This file is part of Caelum.</span>
<a name="l00003"></a>00003 <span class="comment">See http://www.ogre3d.org/wiki/index.php/Caelum </span>
<a name="l00004"></a>00004 <span class="comment"></span>
<a name="l00005"></a>00005 <span class="comment">Copyright (c) 2006-2008 Caelum team. See Contributors.txt for details.</span>
<a name="l00006"></a>00006 <span class="comment"></span>
<a name="l00007"></a>00007 <span class="comment">Caelum is free software: you can redistribute it and/or modify</span>
<a name="l00008"></a>00008 <span class="comment">it under the terms of the GNU Lesser General Public License as published</span>
<a name="l00009"></a>00009 <span class="comment">by the Free Software Foundation, either version 3 of the License, or</span>
<a name="l00010"></a>00010 <span class="comment">(at your option) any later version.</span>
<a name="l00011"></a>00011 <span class="comment"></span>
<a name="l00012"></a>00012 <span class="comment">Caelum is distributed in the hope that it will be useful,</span>
<a name="l00013"></a>00013 <span class="comment">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00014"></a>00014 <span class="comment">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00015"></a>00015 <span class="comment">GNU Lesser General Public License for more details.</span>
<a name="l00016"></a>00016 <span class="comment"></span>
<a name="l00017"></a>00017 <span class="comment">You should have received a copy of the GNU Lesser General Public License</span>
<a name="l00018"></a>00018 <span class="comment">along with Caelum. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l00019"></a>00019 <span class="comment">*/</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="preprocessor">#include "CaelumPrecompiled.h"</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include "CaelumSystem.h"</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include "CaelumExceptions.h"</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include "InternalUtilities.h"</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include "Astronomy.h"</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include "CaelumPlugin.h"</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include "FlatCloudLayer.h"</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="keyword">using namespace </span>Ogre;
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="keyword">namespace </span>Caelum
<a name="l00032"></a>00032 {
<a name="l00033"></a>00033     <span class="keyword">const</span> String CaelumSystem::DEFAULT_SKY_GRADIENTS_IMAGE = <span class="stringliteral">"EarthClearSky2.png"</span>;
<a name="l00034"></a>00034     <span class="keyword">const</span> String CaelumSystem::DEFAULT_SUN_COLOURS_IMAGE = <span class="stringliteral">"SunGradient.png"</span>;
<a name="l00035"></a>00035 
<a name="l00036"></a>00036     <a class="code" href="classCaelum_1_1CaelumSystem.html#fceb52747d6fb877b71de194cbcea915" title="Constructor.">CaelumSystem::CaelumSystem</a>
<a name="l00037"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#fceb52747d6fb877b71de194cbcea915">00037</a>     (
<a name="l00038"></a>00038         Ogre::Root *root, 
<a name="l00039"></a>00039         Ogre::SceneManager *sceneMgr,
<a name="l00040"></a>00040         <a class="code" href="classCaelum_1_1CaelumSystem.html#caef1cba10339738f9ab03e9de00f280" title="Flags enumeration for caelum components.">CaelumComponent</a> componentsToCreate<span class="comment">/* = CAELUM_COMPONENTS_DEFAULT*/</span>
<a name="l00041"></a>00041     ):
<a name="l00042"></a>00042         mOgreRoot (root),
<a name="l00043"></a>00043         mSceneMgr (sceneMgr),
<a name="l00044"></a>00044         mCleanup (<span class="keyword">false</span>)
<a name="l00045"></a>00045     {
<a name="l00046"></a>00046         LogManager::getSingleton().logMessage (<span class="stringliteral">"Caelum: Initialising Caelum system..."</span>);
<a name="l00047"></a>00047         <span class="comment">//LogManager::getSingleton().logMessage ("Caelum: CaelumSystem* at d" +</span>
<a name="l00048"></a>00048         <span class="comment">//        StringConverter::toString (reinterpret_cast&lt;uint&gt;(this)));</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050         Ogre::String uniqueId = Ogre::StringConverter::toString ((<span class="keywordtype">size_t</span>)<span class="keyword">this</span>);
<a name="l00051"></a>00051         <span class="keywordflow">if</span> (!<a class="code" href="classCaelum_1_1CaelumPlugin.html#a05a18c75c7df4725a6d5fd0ff591c6e" title="Get pointer to singleton instance; or pointer if N/A.">CaelumPlugin::getSingletonPtr</a> ()) {
<a name="l00052"></a>00052             LogManager::getSingleton().logMessage (<span class="stringliteral">"Caelum: Plugin not installed; installing now."</span>);
<a name="l00053"></a>00053             <span class="keyword">new</span> <a class="code" href="classCaelum_1_1CaelumPlugin.html" title="Implement an Ogre::Plugin for Caelum.">CaelumPlugin</a> ();
<a name="l00054"></a>00054             <a class="code" href="classCaelum_1_1CaelumPlugin.html#a05a18c75c7df4725a6d5fd0ff591c6e" title="Get pointer to singleton instance; or pointer if N/A.">CaelumPlugin::getSingletonPtr</a> ()-&gt;install ();
<a name="l00055"></a>00055             <a class="code" href="classCaelum_1_1CaelumPlugin.html#a05a18c75c7df4725a6d5fd0ff591c6e" title="Get pointer to singleton instance; or pointer if N/A.">CaelumPlugin::getSingletonPtr</a> ()-&gt;initialise ();
<a name="l00056"></a>00056         }
<a name="l00057"></a>00057 
<a name="l00058"></a>00058         mCaelumCameraNode.reset(mSceneMgr-&gt;getRootSceneNode ()-&gt;createChildSceneNode (<span class="stringliteral">"Caelum/CameraNode/"</span> + uniqueId));
<a name="l00059"></a>00059         mCaelumGroundNode.reset(mSceneMgr-&gt;getRootSceneNode ()-&gt;createChildSceneNode (<span class="stringliteral">"Caelum/GroundNode/"</span> + uniqueId));
<a name="l00060"></a>00060         mUniversalClock.reset(<span class="keyword">new</span> <a class="code" href="classCaelum_1_1UniversalClock.html" title="The system&amp;#39;s time model.">UniversalClock</a> ());
<a name="l00061"></a>00061 
<a name="l00062"></a>00062         <span class="comment">// If the "Caelum" resource group does not exist; create it.</span>
<a name="l00063"></a>00063         <span class="comment">// This resource group is never released; which may be bad.</span>
<a name="l00064"></a>00064         <span class="comment">// What does ogre do for it's own runtime resources?</span>
<a name="l00065"></a>00065         Ogre::StringVector groups = ResourceGroupManager::getSingleton ().getResourceGroups ();
<a name="l00066"></a>00066         <span class="keywordflow">if</span> (std::find (groups.begin(), groups.end(), Caelum::RESOURCE_GROUP_NAME) == groups.end()) {
<a name="l00067"></a>00067             LogManager::getSingleton ().logMessage (
<a name="l00068"></a>00068                     <span class="stringliteral">"Caelum: Creating required internal resource group \'"</span> + RESOURCE_GROUP_NAME + <span class="stringliteral">"\'"</span>);
<a name="l00069"></a>00069             ResourceGroupManager::getSingleton ().createResourceGroup (Caelum::RESOURCE_GROUP_NAME);
<a name="l00070"></a>00070         }
<a name="l00071"></a>00071 
<a name="l00072"></a>00072         <span class="comment">// Autoconfigure. Calls clear first to set defaults.</span>
<a name="l00073"></a>00073         autoConfigure (componentsToCreate);
<a name="l00074"></a>00074     }
<a name="l00075"></a>00075 
<a name="l00076"></a>00076     <span class="keywordtype">void</span> CaelumSystem::destroySubcomponents (<span class="keywordtype">bool</span> destroyEverything)
<a name="l00077"></a>00077     {
<a name="l00078"></a>00078         <span class="comment">// Destroy sub-components</span>
<a name="l00079"></a>00079         <a class="code" href="classCaelum_1_1CaelumSystem.html#e57aad5c8e58ba781eedf6ffbfed1f9f" title="Set the skydome, or null to disable.">setSkyDome</a> (0);
<a name="l00080"></a>00080         <a class="code" href="classCaelum_1_1CaelumSystem.html#19d247a82061a41ed17b5dff38ecc3e6" title="Set the sun, or null to disable.">setSun</a> (0);
<a name="l00081"></a>00081         <a class="code" href="classCaelum_1_1CaelumSystem.html#6251fac401929b3c8291904a9f5d5953" title="Set image starfield, or null to disable.">setImageStarfield</a> (0);
<a name="l00082"></a>00082         <a class="code" href="classCaelum_1_1CaelumSystem.html#192b11bd922b25f549509d36efe89b55" title="Set image starfield, or null to disable.">setPointStarfield</a> (0);
<a name="l00083"></a>00083         <a class="code" href="classCaelum_1_1CaelumSystem.html#02e8557e74e1a6cdb30561d9b690caa8" title="Set cloud system; or null to disable.">setCloudSystem</a> (0);
<a name="l00084"></a>00084         <a class="code" href="classCaelum_1_1CaelumSystem.html#d752321c5b37e930264a8453c1ce53ae" title="Set precipitation controller; or null to disable.">setPrecipitationController</a> (0);
<a name="l00085"></a>00085         <a class="code" href="classCaelum_1_1CaelumSystem.html#9958c887a2d2db7bbcb65bd119a08282" title="Set depth composer; or null to disable.">setDepthComposer</a> (0);
<a name="l00086"></a>00086         <a class="code" href="classCaelum_1_1CaelumSystem.html#e395098b3d10cbc576eb2185d2631c14" title="Sets ground fog system, or null to disable.">setGroundFog</a> (0);
<a name="l00087"></a>00087         <a class="code" href="classCaelum_1_1CaelumSystem.html#f2431c4d87ec9ecbb332be53c943f9c7" title="Set the moon, or null to disable.">setMoon</a> (0);   
<a name="l00088"></a>00088         mSkyGradientsImage.reset ();
<a name="l00089"></a>00089         mSunColoursImage.reset ();
<a name="l00090"></a>00090 
<a name="l00091"></a>00091         <span class="comment">// These things can't be rebuilt.</span>
<a name="l00092"></a>00092         <span class="keywordflow">if</span> (destroyEverything) {
<a name="l00093"></a>00093             LogManager::getSingleton ().logMessage(<span class="stringliteral">"Caelum: Delete UniversalClock"</span>);
<a name="l00094"></a>00094             mUniversalClock.reset ();
<a name="l00095"></a>00095             mCaelumCameraNode.<a class="code" href="classCaelum_1_1PrivatePtr.html#aa15793f77deb2577a1ebfa93750d093" title="Change the inner value.">reset</a> ();
<a name="l00096"></a>00096             mCaelumGroundNode.<a class="code" href="classCaelum_1_1PrivatePtr.html#aa15793f77deb2577a1ebfa93750d093" title="Change the inner value.">reset</a> ();
<a name="l00097"></a>00097         }
<a name="l00098"></a>00098     }
<a name="l00099"></a>00099 
<a name="l00100"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#bed1f453b51d90428e23599ba713b0c5">00100</a>     <a class="code" href="classCaelum_1_1CaelumSystem.html#bed1f453b51d90428e23599ba713b0c5" title="Destructor.">CaelumSystem::~CaelumSystem</a> () {
<a name="l00101"></a>00101         destroySubcomponents (<span class="keyword">true</span>);
<a name="l00102"></a>00102         LogManager::getSingleton ().logMessage (<span class="stringliteral">"Caelum: CaelumSystem destroyed."</span>);
<a name="l00103"></a>00103     }
<a name="l00104"></a>00104 
<a name="l00105"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#169f8475d4724ed06b1514107f27469e">00105</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#169f8475d4724ed06b1514107f27469e" title="Revert everything to defaults.">CaelumSystem::clear</a>()
<a name="l00106"></a>00106     {
<a name="l00107"></a>00107         <span class="comment">// Destroy all subcomponents first.</span>
<a name="l00108"></a>00108         destroySubcomponents (<span class="keyword">false</span>);
<a name="l00109"></a>00109 
<a name="l00110"></a>00110         <span class="comment">// Some "magical" behaviour.</span>
<a name="l00111"></a>00111         mAutoMoveCameraNode = <span class="keyword">true</span>;
<a name="l00112"></a>00112         mAutoNotifyCameraChanged = <span class="keyword">true</span>;
<a name="l00113"></a>00113         mAutoAttachViewportsToComponents = <span class="keyword">true</span>;
<a name="l00114"></a>00114         mAutoViewportBackground = <span class="keyword">true</span>;
<a name="l00115"></a>00115 
<a name="l00116"></a>00116         <span class="comment">// Default lookups.</span>
<a name="l00117"></a>00117         <a class="code" href="classCaelum_1_1CaelumSystem.html#80f9fc6389880cba376799b8a1e7c0e0" title="Set the sun gradients image.">setSkyGradientsImage</a>(DEFAULT_SKY_GRADIENTS_IMAGE);
<a name="l00118"></a>00118         <a class="code" href="classCaelum_1_1CaelumSystem.html#2c646e7a27f7d819b2ae9bd5490962e0" title="Set the sun colours image.">setSunColoursImage</a>(DEFAULT_SUN_COLOURS_IMAGE);
<a name="l00119"></a>00119 
<a name="l00120"></a>00120         <span class="comment">// Fog defaults.</span>
<a name="l00121"></a>00121         <a class="code" href="classCaelum_1_1CaelumSystem.html#5124c2195ad84022300d5054c3a441d9" title="Enables/disables Caelum managing standard Ogre::Scene fog.">setManageSceneFog</a> (<span class="keyword">true</span>);
<a name="l00122"></a>00122         mGlobalFogDensityMultiplier = 1;
<a name="l00123"></a>00123         mGlobalFogColourMultiplier = Ogre::ColourValue(1.0, 1.0, 1.0, 1.0);
<a name="l00124"></a>00124         mSceneFogDensityMultiplier = 1;
<a name="l00125"></a>00125         mSceneFogColourMultiplier = Ogre::ColourValue(0.7, 0.7, 0.7, 0.7);
<a name="l00126"></a>00126         mGroundFogDensityMultiplier = 1;
<a name="l00127"></a>00127         mGroundFogColourMultiplier = Ogre::ColourValue(1.0, 1.0, 1.0, 1.0);
<a name="l00128"></a>00128 
<a name="l00129"></a>00129         <span class="comment">// Ambient lighting.</span>
<a name="l00130"></a>00130         <a class="code" href="classCaelum_1_1CaelumSystem.html#403a3b806af32458d31f5835fa0cbafc" title="Set this to true to have CaelumSystem manage the scene&amp;#39;s ambient light.">setManageAmbientLight</a> (<span class="keyword">true</span>);
<a name="l00131"></a>00131         <a class="code" href="classCaelum_1_1CaelumSystem.html#9ae64903ce347353d5f13d15e3732009" title="Set the minimum value for scene ambient lighting, This is only used if getManageAmbientLight()...">setMinimumAmbientLight</a> (Ogre::ColourValue (0.1, 0.1, 0.3));
<a name="l00132"></a>00132         mEnsureSingleLightSource = <span class="keyword">false</span>;
<a name="l00133"></a>00133         mEnsureSingleShadowSource = <span class="keyword">false</span>;
<a name="l00134"></a>00134 
<a name="l00135"></a>00135         <span class="comment">// Observer time &amp; position. J2000 is midday.</span>
<a name="l00136"></a>00136         mObserverLatitude = Ogre::Degree(45);
<a name="l00137"></a>00137         mObserverLongitude = Ogre::Degree(0);
<a name="l00138"></a>00138         mUniversalClock-&gt;setJulianDay (<a class="code" href="classCaelum_1_1Astronomy.html#153c733a2ea973d92626fa2932d6d66a" title="January 1, 2000, noon.">Astronomy::J2000</a>);
<a name="l00139"></a>00139     }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#42ee6d5d702b1be4fd8bab9094d18a09" title="Create some default component with resonable default settings.">CaelumSystem::autoConfigure</a>
<a name="l00142"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#42ee6d5d702b1be4fd8bab9094d18a09">00142</a>     (
<a name="l00143"></a>00143         <a class="code" href="classCaelum_1_1CaelumSystem.html#caef1cba10339738f9ab03e9de00f280" title="Flags enumeration for caelum components.">CaelumComponent</a> componentsToCreate<span class="comment">/* = CAELUM_COMPONENTS_DEFAULT*/</span>
<a name="l00144"></a>00144     )
<a name="l00145"></a>00145     {
<a name="l00146"></a>00146         <span class="comment">// Clear everything; revert to default.</span>
<a name="l00147"></a>00147         clear();
<a name="l00148"></a>00148 
<a name="l00149"></a>00149         <span class="keywordflow">if</span> (componentsToCreate == 0) {
<a name="l00150"></a>00150             <span class="comment">// Nothing to do. Don't print junk if not creating anything.</span>
<a name="l00151"></a>00151             <span class="keywordflow">return</span>;
<a name="l00152"></a>00152         }
<a name="l00153"></a>00153         LogManager::getSingleton ().logMessage (<span class="stringliteral">"Caelum: Creating caelum sub-components."</span>);
<a name="l00154"></a>00154 
<a name="l00155"></a>00155         <span class="comment">// Init skydome</span>
<a name="l00156"></a>00156         <span class="keywordflow">if</span> (componentsToCreate &amp; CAELUM_COMPONENT_SKY_DOME) {
<a name="l00157"></a>00157             <span class="keywordflow">try</span> {
<a name="l00158"></a>00158                 this-&gt;setSkyDome (<span class="keyword">new</span> <a class="code" href="classCaelum_1_1SkyDome.html" title="A sky dome element.">SkyDome</a> (mSceneMgr, getCaelumCameraNode ()));
<a name="l00159"></a>00159             } <span class="keywordflow">catch</span> (<a class="code" href="classCaelum_1_1UnsupportedException.html" title="Exception class for unsupported features.">Caelum::UnsupportedException</a>&amp; ex) {
<a name="l00160"></a>00160                 LogManager::getSingleton ().logMessage (
<a name="l00161"></a>00161                         <span class="stringliteral">"Caelum: Failed to initialize skydome: "</span> + ex.getFullDescription());
<a name="l00162"></a>00162             }
<a name="l00163"></a>00163         }
<a name="l00164"></a>00164         
<a name="l00165"></a>00165         <span class="comment">// Init sun</span>
<a name="l00166"></a>00166         <span class="keywordflow">if</span> (componentsToCreate &amp; CAELUM_COMPONENT_SUN) {
<a name="l00167"></a>00167             <span class="keywordflow">try</span> {
<a name="l00168"></a>00168                 this-&gt;setSun (<span class="keyword">new</span> <a class="code" href="classCaelum_1_1SpriteSun.html" title="Class representing the sun as billboard with texture on it.">SpriteSun</a> (mSceneMgr, getCaelumCameraNode ()));
<a name="l00169"></a>00169                 this-&gt;getSun ()-&gt;setAmbientMultiplier (Ogre::ColourValue (0.5, 0.5, 0.5));
<a name="l00170"></a>00170                 this-&gt;getSun ()-&gt;setDiffuseMultiplier (Ogre::ColourValue (3, 3, 2.7));
<a name="l00171"></a>00171                 this-&gt;getSun ()-&gt;setSpecularMultiplier (Ogre::ColourValue (5, 5, 5));
<a name="l00172"></a>00172 
<a name="l00173"></a>00173                 this-&gt;getSun ()-&gt;setAutoDisable (<span class="keyword">true</span>);
<a name="l00174"></a>00174                 this-&gt;getSun ()-&gt;setAutoDisableThreshold (0.05);
<a name="l00175"></a>00175             } <span class="keywordflow">catch</span> (<a class="code" href="classCaelum_1_1UnsupportedException.html" title="Exception class for unsupported features.">Caelum::UnsupportedException</a>&amp; ex) {
<a name="l00176"></a>00176                 LogManager::getSingleton ().logMessage (
<a name="l00177"></a>00177                         <span class="stringliteral">"Caelum: Failed to initialize sun: "</span> + ex.getFullDescription());
<a name="l00178"></a>00178             }
<a name="l00179"></a>00179         }
<a name="l00180"></a>00180 
<a name="l00181"></a>00181         <span class="comment">// Init moon</span>
<a name="l00182"></a>00182         <span class="keywordflow">if</span> (componentsToCreate &amp; CAELUM_COMPONENT_MOON) {
<a name="l00183"></a>00183             <span class="keywordflow">try</span> {
<a name="l00184"></a>00184                 this-&gt;setMoon (<span class="keyword">new</span> <a class="code" href="classCaelum_1_1Moon.html" title="Class representing the moon.">Moon</a> (mSceneMgr, getCaelumCameraNode ()));
<a name="l00185"></a>00185                 this-&gt;getMoon ()-&gt;setAutoDisable (<span class="keyword">true</span>);
<a name="l00186"></a>00186                 this-&gt;getMoon ()-&gt;setAutoDisableThreshold (0.05);
<a name="l00187"></a>00187             } <span class="keywordflow">catch</span> (<a class="code" href="classCaelum_1_1UnsupportedException.html" title="Exception class for unsupported features.">Caelum::UnsupportedException</a>&amp; ex) {
<a name="l00188"></a>00188                 LogManager::getSingleton ().logMessage (
<a name="l00189"></a>00189                         <span class="stringliteral">"Caelum: Failed to initialize moon: "</span> + ex.getFullDescription());
<a name="l00190"></a>00190             }
<a name="l00191"></a>00191         }
<a name="l00192"></a>00192         <span class="keywordflow">if</span> (componentsToCreate &amp; CAELUM_COMPONENT_IMAGE_STARFIELD) {
<a name="l00193"></a>00193             <span class="keywordflow">try</span> {
<a name="l00194"></a>00194                 this-&gt;setImageStarfield (<span class="keyword">new</span> <a class="code" href="classCaelum_1_1ImageStarfield.html" title="Image-based starfield class.">ImageStarfield</a> (mSceneMgr, getCaelumCameraNode ()));
<a name="l00195"></a>00195             } <span class="keywordflow">catch</span> (<a class="code" href="classCaelum_1_1UnsupportedException.html" title="Exception class for unsupported features.">Caelum::UnsupportedException</a>&amp; ex) {
<a name="l00196"></a>00196                 LogManager::getSingleton ().logMessage (
<a name="l00197"></a>00197                         <span class="stringliteral">"Caelum: Failed to initialize the old image starfield: "</span> + ex.getFullDescription());
<a name="l00198"></a>00198             }
<a name="l00199"></a>00199         }
<a name="l00200"></a>00200         <span class="keywordflow">if</span> (componentsToCreate &amp; CAELUM_COMPONENT_POINT_STARFIELD) {
<a name="l00201"></a>00201             <span class="keywordflow">try</span> {
<a name="l00202"></a>00202                 this-&gt;setPointStarfield (<span class="keyword">new</span> <a class="code" href="classCaelum_1_1PointStarfield.html" title="Point starfield class.">PointStarfield</a> (mSceneMgr, getCaelumCameraNode ()));
<a name="l00203"></a>00203             } <span class="keywordflow">catch</span> (<a class="code" href="classCaelum_1_1UnsupportedException.html" title="Exception class for unsupported features.">Caelum::UnsupportedException</a>&amp; ex) {
<a name="l00204"></a>00204                 LogManager::getSingleton ().logMessage (
<a name="l00205"></a>00205                         <span class="stringliteral">"Caelum: Failed to initialize starfield: "</span> + ex.getFullDescription());
<a name="l00206"></a>00206             }
<a name="l00207"></a>00207         }
<a name="l00208"></a>00208         <span class="keywordflow">if</span> (componentsToCreate &amp; CAELUM_COMPONENT_GROUND_FOG) {
<a name="l00209"></a>00209             <span class="keywordflow">try</span> {
<a name="l00210"></a>00210                this-&gt;setGroundFog (<span class="keyword">new</span> <a class="code" href="classCaelum_1_1GroundFog.html" title="Exponential ground fog system implementation.">GroundFog</a> (mSceneMgr, getCaelumCameraNode ()));
<a name="l00211"></a>00211             } <span class="keywordflow">catch</span> (<a class="code" href="classCaelum_1_1UnsupportedException.html" title="Exception class for unsupported features.">Caelum::UnsupportedException</a>&amp; ex) {
<a name="l00212"></a>00212                 LogManager::getSingleton ().logMessage (
<a name="l00213"></a>00213                         <span class="stringliteral">"Caelum: Failed to initialize ground fog: "</span> + ex.getFullDescription());
<a name="l00214"></a>00214             }
<a name="l00215"></a>00215         }
<a name="l00216"></a>00216         <span class="keywordflow">if</span> (componentsToCreate &amp; CAELUM_COMPONENT_CLOUDS) {
<a name="l00217"></a>00217             <span class="keywordflow">try</span> {
<a name="l00218"></a>00218                 this-&gt;setCloudSystem (<span class="keyword">new</span> <a class="code" href="classCaelum_1_1CloudSystem.html" title="A cloud system is implemented by a number of cloud layers.">CloudSystem</a> (mSceneMgr, getCaelumGroundNode ()));
<a name="l00219"></a>00219                 getCloudSystem ()-&gt;createLayerAtHeight (3000);      
<a name="l00220"></a>00220                 getCloudSystem ()-&gt;getLayer (0)-&gt;setCloudCover (0.3);
<a name="l00221"></a>00221             } <span class="keywordflow">catch</span> (<a class="code" href="classCaelum_1_1UnsupportedException.html" title="Exception class for unsupported features.">Caelum::UnsupportedException</a>&amp; ex) {
<a name="l00222"></a>00222                 LogManager::getSingleton ().logMessage (
<a name="l00223"></a>00223                         <span class="stringliteral">"Caelum: Failed to initialize clouds: "</span> + ex.getFullDescription());
<a name="l00224"></a>00224             }
<a name="l00225"></a>00225         }
<a name="l00226"></a>00226         <span class="keywordflow">if</span> (componentsToCreate &amp; CAELUM_COMPONENT_PRECIPITATION) {
<a name="l00227"></a>00227             <span class="keywordflow">try</span> {
<a name="l00228"></a>00228                 this-&gt;setPrecipitationController (<span class="keyword">new</span> <a class="code" href="classCaelum_1_1PrecipitationController.html" title="Compositor-based precipitation controller.">PrecipitationController</a> (mSceneMgr));
<a name="l00229"></a>00229             } <span class="keywordflow">catch</span> (<a class="code" href="classCaelum_1_1UnsupportedException.html" title="Exception class for unsupported features.">Caelum::UnsupportedException</a>&amp; ex) {
<a name="l00230"></a>00230                 LogManager::getSingleton ().logMessage (
<a name="l00231"></a>00231                         <span class="stringliteral">"Caelum: Failed to initialize precipitation: "</span> + ex.getFullDescription());
<a name="l00232"></a>00232             }
<a name="l00233"></a>00233         }
<a name="l00234"></a>00234         <span class="keywordflow">if</span> (componentsToCreate &amp; CAELUM_COMPONENT_SCREEN_SPACE_FOG) {
<a name="l00235"></a>00235             <span class="keywordflow">try</span> {
<a name="l00236"></a>00236                 this-&gt;setDepthComposer (<span class="keyword">new</span> <a class="code" href="classCaelum_1_1DepthComposer.html" title="Compositor-based precipitation controller.">DepthComposer</a> (mSceneMgr));
<a name="l00237"></a>00237             } <span class="keywordflow">catch</span> (<a class="code" href="classCaelum_1_1UnsupportedException.html" title="Exception class for unsupported features.">Caelum::UnsupportedException</a>&amp; ex) {
<a name="l00238"></a>00238                 LogManager::getSingleton ().logMessage (
<a name="l00239"></a>00239                         <span class="stringliteral">"Caelum: Failed to initialize precipitation: "</span> + ex.getFullDescription());
<a name="l00240"></a>00240             }
<a name="l00241"></a>00241         }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243         LogManager::getSingleton ().logMessage (<span class="stringliteral">"Caelum: DONE initializing"</span>);
<a name="l00244"></a>00244     }
<a name="l00245"></a>00245 
<a name="l00246"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#ea3bcc7c7db5492b8d52fa501430c61a">00246</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#ea3bcc7c7db5492b8d52fa501430c61a" title="Shuts down the system and detaches itself from the Ogre engine.">CaelumSystem::shutdown</a> (<span class="keyword">const</span> <span class="keywordtype">bool</span> cleanup) {
<a name="l00247"></a>00247         LogManager::getSingleton ().logMessage (<span class="stringliteral">"Caelum: Shutting down Caelum system..."</span>);
<a name="l00248"></a>00248 
<a name="l00249"></a>00249         destroySubcomponents (<span class="keyword">true</span>);
<a name="l00250"></a>00250 
<a name="l00251"></a>00251         <span class="keywordflow">if</span> (cleanup) {
<a name="l00252"></a>00252             mOgreRoot-&gt;removeFrameListener (<span class="keyword">this</span>);
<a name="l00253"></a>00253             <span class="keyword">delete</span> <span class="keyword">this</span>;
<a name="l00254"></a>00254         } <span class="keywordflow">else</span> {
<a name="l00255"></a>00255             <span class="comment">// We'll delete later. Make sure we're registered as a frame listener, or we'd leak.</span>
<a name="l00256"></a>00256             mOgreRoot-&gt;addFrameListener(<span class="keyword">this</span>);
<a name="l00257"></a>00257             mCleanup = <span class="keyword">true</span>;
<a name="l00258"></a>00258         }
<a name="l00259"></a>00259     }
<a name="l00260"></a>00260 
<a name="l00261"></a>00261     <span class="keywordtype">void</span> CaelumSystem::attachViewportImpl (Ogre::Viewport* vp)
<a name="l00262"></a>00262     {
<a name="l00263"></a>00263         LogManager::getSingleton().getDefaultLog ()-&gt;logMessage (
<a name="l00264"></a>00264                 <span class="stringliteral">"CaelumSystem: Attached to"</span>
<a name="l00265"></a>00265                 <span class="stringliteral">" viewport "</span> + StringConverter::toString ((<span class="keywordtype">long</span>)vp) +
<a name="l00266"></a>00266                 <span class="stringliteral">" render target "</span> + vp-&gt;getTarget ()-&gt;getName ());
<a name="l00267"></a>00267         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#c9274f13601ec768b214f72bed153216">getAutoAttachViewportsToComponents</a> ()) {
<a name="l00268"></a>00268             <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#6a1d206466ff1d3513d39071e690c352" title="Get precipitation controller; or null if disabled.">getPrecipitationController</a> ()) {
<a name="l00269"></a>00269                 <a class="code" href="classCaelum_1_1CaelumSystem.html#6a1d206466ff1d3513d39071e690c352" title="Get precipitation controller; or null if disabled.">getPrecipitationController</a> ()-&gt;<a class="code" href="classCaelum_1_1PrecipitationController.html#ff2389bc71886edb8f87537c73bd46b7" title="Add precipitation to a certain viewport.">createViewportInstance</a> (vp);
<a name="l00270"></a>00270             }
<a name="l00271"></a>00271             <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#f973506cf9495617323446f1ea35f6d3" title="Get depth composer; or null if disabled.">getDepthComposer</a> ()) {
<a name="l00272"></a>00272                 <a class="code" href="classCaelum_1_1CaelumSystem.html#f973506cf9495617323446f1ea35f6d3" title="Get depth composer; or null if disabled.">getDepthComposer</a> ()-&gt;createViewportInstance (vp);
<a name="l00273"></a>00273             }
<a name="l00274"></a>00274         }
<a name="l00275"></a>00275     }
<a name="l00276"></a>00276 
<a name="l00277"></a>00277     <span class="keywordtype">void</span> CaelumSystem::detachViewportImpl (Ogre::Viewport* vp)
<a name="l00278"></a>00278     {
<a name="l00279"></a>00279         LogManager::getSingleton().getDefaultLog ()-&gt;logMessage (
<a name="l00280"></a>00280                 <span class="stringliteral">"CaelumSystem: Detached from "</span>
<a name="l00281"></a>00281                 <span class="stringliteral">" viewport "</span> + StringConverter::toString ((<span class="keywordtype">long</span>)vp) +
<a name="l00282"></a>00282                 <span class="stringliteral">" render target "</span> + vp-&gt;getTarget ()-&gt;getName ());
<a name="l00283"></a>00283         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#c9274f13601ec768b214f72bed153216">getAutoAttachViewportsToComponents</a> ()) {
<a name="l00284"></a>00284             <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#6a1d206466ff1d3513d39071e690c352" title="Get precipitation controller; or null if disabled.">getPrecipitationController</a> ()) {
<a name="l00285"></a>00285                 <a class="code" href="classCaelum_1_1CaelumSystem.html#6a1d206466ff1d3513d39071e690c352" title="Get precipitation controller; or null if disabled.">getPrecipitationController</a> ()-&gt;destroyViewportInstance (vp);
<a name="l00286"></a>00286             }
<a name="l00287"></a>00287             <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#f973506cf9495617323446f1ea35f6d3" title="Get depth composer; or null if disabled.">getDepthComposer</a> ()) {
<a name="l00288"></a>00288                 <a class="code" href="classCaelum_1_1CaelumSystem.html#f973506cf9495617323446f1ea35f6d3" title="Get depth composer; or null if disabled.">getDepthComposer</a> ()-&gt;destroyViewportInstance (vp);
<a name="l00289"></a>00289             }
<a name="l00290"></a>00290         }
<a name="l00291"></a>00291     }
<a name="l00292"></a>00292     
<a name="l00293"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#e5d3320067bf40ce12d855cccd5ba8cb">00293</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#e5d3320067bf40ce12d855cccd5ba8cb" title="Attach CaelumSystem to a viewport.">CaelumSystem::attachViewport</a> (Ogre::Viewport* vp)
<a name="l00294"></a>00294     {
<a name="l00295"></a>00295         <span class="keywordtype">bool</span> found = !mAttachedViewports.insert (vp).second;
<a name="l00296"></a>00296         <span class="keywordflow">if</span> (!found) {
<a name="l00297"></a>00297             attachViewportImpl (vp);
<a name="l00298"></a>00298         }
<a name="l00299"></a>00299     }
<a name="l00300"></a>00300 
<a name="l00301"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#520f501a7d9bb84592786496f453b689">00301</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#520f501a7d9bb84592786496f453b689" title="Reverse of.">CaelumSystem::detachViewport</a> (Ogre::Viewport* vp)
<a name="l00302"></a>00302     {
<a name="l00303"></a>00303         std::set&lt;Viewport*&gt;::size_type erase_result = mAttachedViewports.erase(vp);
<a name="l00304"></a>00304         assert(erase_result == 0 || erase_result == 1);
<a name="l00305"></a>00305         <span class="keywordtype">bool</span> found = erase_result == 1;
<a name="l00306"></a>00306         <span class="keywordflow">if</span> (found) {
<a name="l00307"></a>00307             detachViewportImpl (vp);
<a name="l00308"></a>00308         }
<a name="l00309"></a>00309     }
<a name="l00310"></a>00310 
<a name="l00311"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#b41274684e4169c3c1b8675084f567ea">00311</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#b41274684e4169c3c1b8675084f567ea" title="Detach from all viewports.">CaelumSystem::detachAllViewports</a> ()
<a name="l00312"></a>00312     {
<a name="l00313"></a>00313         std::set&lt;Viewport*&gt;::const_iterator it = mAttachedViewports.begin(), end = mAttachedViewports.end();
<a name="l00314"></a>00314         <span class="keywordflow">for</span> (; it != end; ++it) {
<a name="l00315"></a>00315             detachViewportImpl (*it);
<a name="l00316"></a>00316         }
<a name="l00317"></a>00317         mAttachedViewports.clear();
<a name="l00318"></a>00318     }
<a name="l00319"></a>00319 
<a name="l00320"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#415172c32c8865cda6a0a774e14b1dee">00320</a>     <span class="keywordtype">bool</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#415172c32c8865cda6a0a774e14b1dee" title="Check if one particular viewport is attached.">CaelumSystem::isViewportAttached</a> (Ogre::Viewport* vp)<span class="keyword"> const </span>{
<a name="l00321"></a>00321         <span class="keywordflow">return</span> mAttachedViewports.find (vp) != mAttachedViewports.end();
<a name="l00322"></a>00322     }
<a name="l00323"></a>00323 
<a name="l00324"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#e57aad5c8e58ba781eedf6ffbfed1f9f">00324</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#e57aad5c8e58ba781eedf6ffbfed1f9f" title="Set the skydome, or null to disable.">CaelumSystem::setSkyDome</a> (<a class="code" href="classCaelum_1_1SkyDome.html" title="A sky dome element.">SkyDome</a> *obj) {
<a name="l00325"></a>00325         mSkyDome.reset (obj);
<a name="l00326"></a>00326     }
<a name="l00327"></a>00327 
<a name="l00328"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#19d247a82061a41ed17b5dff38ecc3e6">00328</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#19d247a82061a41ed17b5dff38ecc3e6" title="Set the sun, or null to disable.">CaelumSystem::setSun</a> (<a class="code" href="classCaelum_1_1BaseSkyLight.html" title="Base class for sky lights (sun and moon).">BaseSkyLight</a>* obj) {
<a name="l00329"></a>00329         mSun.reset (obj);
<a name="l00330"></a>00330     }
<a name="l00331"></a>00331 
<a name="l00332"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#f2431c4d87ec9ecbb332be53c943f9c7">00332</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#f2431c4d87ec9ecbb332be53c943f9c7" title="Set the moon, or null to disable.">CaelumSystem::setMoon</a> (<a class="code" href="classCaelum_1_1Moon.html" title="Class representing the moon.">Moon</a>* obj) {
<a name="l00333"></a>00333         mMoon.reset (obj);
<a name="l00334"></a>00334     }
<a name="l00335"></a>00335 
<a name="l00336"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#6251fac401929b3c8291904a9f5d5953">00336</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#6251fac401929b3c8291904a9f5d5953" title="Set image starfield, or null to disable.">CaelumSystem::setImageStarfield</a> (<a class="code" href="classCaelum_1_1ImageStarfield.html" title="Image-based starfield class.">ImageStarfield</a>* obj) {
<a name="l00337"></a>00337         mImageStarfield.reset (obj);
<a name="l00338"></a>00338     }
<a name="l00339"></a>00339 
<a name="l00340"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#192b11bd922b25f549509d36efe89b55">00340</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#192b11bd922b25f549509d36efe89b55" title="Set image starfield, or null to disable.">CaelumSystem::setPointStarfield</a> (<a class="code" href="classCaelum_1_1PointStarfield.html" title="Point starfield class.">PointStarfield</a>* obj) {
<a name="l00341"></a>00341         mPointStarfield.reset (obj);
<a name="l00342"></a>00342     }
<a name="l00343"></a>00343 
<a name="l00344"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#e395098b3d10cbc576eb2185d2631c14">00344</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#e395098b3d10cbc576eb2185d2631c14" title="Sets ground fog system, or null to disable.">CaelumSystem::setGroundFog</a> (<a class="code" href="classCaelum_1_1GroundFog.html" title="Exponential ground fog system implementation.">GroundFog</a>* obj) {
<a name="l00345"></a>00345         mGroundFog.reset (obj);
<a name="l00346"></a>00346     }
<a name="l00347"></a>00347 
<a name="l00348"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#02e8557e74e1a6cdb30561d9b690caa8">00348</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#02e8557e74e1a6cdb30561d9b690caa8" title="Set cloud system; or null to disable.">CaelumSystem::setCloudSystem</a> (<a class="code" href="classCaelum_1_1CloudSystem.html" title="A cloud system is implemented by a number of cloud layers.">CloudSystem</a>* obj) {
<a name="l00349"></a>00349         mCloudSystem.reset (obj);
<a name="l00350"></a>00350     }
<a name="l00351"></a>00351 
<a name="l00352"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#d752321c5b37e930264a8453c1ce53ae">00352</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#d752321c5b37e930264a8453c1ce53ae" title="Set precipitation controller; or null to disable.">CaelumSystem::setPrecipitationController</a> (<a class="code" href="classCaelum_1_1PrecipitationController.html" title="Compositor-based precipitation controller.">PrecipitationController</a>* newptr) {
<a name="l00353"></a>00353         <a class="code" href="classCaelum_1_1PrecipitationController.html" title="Compositor-based precipitation controller.">PrecipitationController</a>* oldptr = <a class="code" href="classCaelum_1_1CaelumSystem.html#6a1d206466ff1d3513d39071e690c352" title="Get precipitation controller; or null if disabled.">getPrecipitationController</a> ();
<a name="l00354"></a>00354         <span class="keywordflow">if</span> (oldptr == newptr) {
<a name="l00355"></a>00355             <span class="keywordflow">return</span>;
<a name="l00356"></a>00356         }
<a name="l00357"></a>00357         <span class="comment">// Detach old</span>
<a name="l00358"></a>00358         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#c9274f13601ec768b214f72bed153216">getAutoAttachViewportsToComponents</a>() &amp;&amp; oldptr) {
<a name="l00359"></a>00359             std::for_each (mAttachedViewports.begin(), mAttachedViewports.end(),
<a name="l00360"></a>00360                     std::bind1st (std::mem_fun (&amp;<a class="code" href="classCaelum_1_1PrecipitationController.html#c4dcb147bcce63336f776349d2f3129c" title="Remove precipitation from a certain viewport.">PrecipitationController::destroyViewportInstance</a>), oldptr));
<a name="l00361"></a>00361         }
<a name="l00362"></a>00362         <span class="comment">// Attach new.</span>
<a name="l00363"></a>00363         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#c9274f13601ec768b214f72bed153216">getAutoAttachViewportsToComponents</a>() &amp;&amp; newptr) {
<a name="l00364"></a>00364             std::for_each (mAttachedViewports.begin(), mAttachedViewports.end(),
<a name="l00365"></a>00365                     std::bind1st (std::mem_fun (&amp;<a class="code" href="classCaelum_1_1PrecipitationController.html#ff2389bc71886edb8f87537c73bd46b7" title="Add precipitation to a certain viewport.">PrecipitationController::createViewportInstance</a>), newptr));
<a name="l00366"></a>00366         }
<a name="l00367"></a>00367         mPrecipitationController.reset(newptr);
<a name="l00368"></a>00368     }
<a name="l00369"></a>00369 
<a name="l00370"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#9958c887a2d2db7bbcb65bd119a08282">00370</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#9958c887a2d2db7bbcb65bd119a08282" title="Set depth composer; or null to disable.">CaelumSystem::setDepthComposer</a> (<a class="code" href="classCaelum_1_1DepthComposer.html" title="Compositor-based precipitation controller.">DepthComposer</a>* ptr) {
<a name="l00371"></a>00371         mDepthComposer.reset(ptr);
<a name="l00372"></a>00372         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#c9274f13601ec768b214f72bed153216">getAutoAttachViewportsToComponents</a>() &amp;&amp; <a class="code" href="classCaelum_1_1CaelumSystem.html#f973506cf9495617323446f1ea35f6d3" title="Get depth composer; or null if disabled.">getDepthComposer</a> ()) {
<a name="l00373"></a>00373             std::for_each (
<a name="l00374"></a>00374                     mAttachedViewports.begin(), mAttachedViewports.end(),
<a name="l00375"></a>00375                     std::bind1st (
<a name="l00376"></a>00376                             std::mem_fun (&amp;DepthComposer::createViewportInstance),
<a name="l00377"></a>00377                             <a class="code" href="classCaelum_1_1CaelumSystem.html#f973506cf9495617323446f1ea35f6d3" title="Get depth composer; or null if disabled.">getDepthComposer</a> ()));
<a name="l00378"></a>00378         }
<a name="l00379"></a>00379     }
<a name="l00380"></a>00380 
<a name="l00381"></a>00381     <span class="keywordtype">void</span> CaelumSystem::preViewportUpdate (<span class="keyword">const</span> Ogre::RenderTargetViewportEvent &amp;e) {
<a name="l00382"></a>00382         Ogre::Viewport *viewport = e.source;
<a name="l00383"></a>00383         Ogre::Camera *camera = viewport-&gt;getCamera ();
<a name="l00384"></a>00384 
<a name="l00385"></a>00385         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#bdfdaa0da63e315cfbce9ac27feec6cc">getAutoViewportBackground</a> ()) {
<a name="l00386"></a>00386             viewport-&gt;setBackgroundColour (Ogre::ColourValue::Black);
<a name="l00387"></a>00387         }
<a name="l00388"></a>00388         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#a8e2042cf0ab7dccef20c01b78e3157b">getAutoNotifyCameraChanged</a> ()) {
<a name="l00389"></a>00389             this-&gt;<a class="code" href="classCaelum_1_1CaelumSystem.html#041316f9327c1d0a3876c7ac9776972b" title="Notify subcomponents of camera changes.">notifyCameraChanged</a> (camera);
<a name="l00390"></a>00390         }
<a name="l00391"></a>00391     }
<a name="l00392"></a>00392 
<a name="l00393"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#041316f9327c1d0a3876c7ac9776972b">00393</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#041316f9327c1d0a3876c7ac9776972b" title="Notify subcomponents of camera changes.">CaelumSystem::notifyCameraChanged</a>(Ogre::Camera* cam)
<a name="l00394"></a>00394     {
<a name="l00395"></a>00395         <span class="comment">// Move camera node.</span>
<a name="l00396"></a>00396         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#6a147736207de4cecffbd342c728de9b">getAutoMoveCameraNode</a> ()) {
<a name="l00397"></a>00397             mCaelumCameraNode-&gt;setPosition (cam-&gt;getDerivedPosition());
<a name="l00398"></a>00398             mCaelumCameraNode-&gt;_update (<span class="keyword">true</span>, <span class="keyword">true</span>);
<a name="l00399"></a>00399         }
<a name="l00400"></a>00400 
<a name="l00401"></a>00401         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#474c5e5fa66f551e168ab3cbf68df1a4" title="Get the current sky dome, or null if disabled.">getSkyDome</a> ()) {
<a name="l00402"></a>00402             <a class="code" href="classCaelum_1_1CaelumSystem.html#474c5e5fa66f551e168ab3cbf68df1a4" title="Get the current sky dome, or null if disabled.">getSkyDome</a> ()-&gt;<a class="code" href="classCaelum_1_1SkyDome.html#92ecc9e3d600c2c05c51bdd8c1edb33a" title="Handle camera change.">notifyCameraChanged</a> (cam);
<a name="l00403"></a>00403         }
<a name="l00404"></a>00404 
<a name="l00405"></a>00405         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#4ba1342732ff0dc1c81d4d0a037c7655" title="Gets the current sun, or null if disabled.">getSun</a> ()) {
<a name="l00406"></a>00406             <a class="code" href="classCaelum_1_1CaelumSystem.html#4ba1342732ff0dc1c81d4d0a037c7655" title="Gets the current sun, or null if disabled.">getSun</a> ()-&gt;<a class="code" href="classCaelum_1_1CameraBoundElement.html#62934f114d7107c7bc3da553ff9a3161" title="Notify new camera conditions.">notifyCameraChanged</a> (cam);
<a name="l00407"></a>00407         }
<a name="l00408"></a>00408 
<a name="l00409"></a>00409         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#922127ba98ea3ec0524d2051d94e3ca8" title="Gets the current moon, or null if disabled.">getMoon</a> ()) {
<a name="l00410"></a>00410             <a class="code" href="classCaelum_1_1CaelumSystem.html#922127ba98ea3ec0524d2051d94e3ca8" title="Gets the current moon, or null if disabled.">getMoon</a> ()-&gt;<a class="code" href="classCaelum_1_1Moon.html#05b8f3fe79f552b525229ec43d0609b2" title="Handle camera change.">notifyCameraChanged</a> (cam);
<a name="l00411"></a>00411         }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#6cc93fd22454a9e01bfb1da7c45f5dc1" title="Gets the current image starfield, or null if disabled.">getImageStarfield</a> ()) {
<a name="l00414"></a>00414             <a class="code" href="classCaelum_1_1CaelumSystem.html#6cc93fd22454a9e01bfb1da7c45f5dc1" title="Gets the current image starfield, or null if disabled.">getImageStarfield</a> ()-&gt;<a class="code" href="classCaelum_1_1ImageStarfield.html#8d7d924ca96c812917780c36ebf7db47" title="Handle camera change.">notifyCameraChanged</a> (cam);
<a name="l00415"></a>00415         }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#6ea428a5c3e12b04820eaad7accfd351" title="Gets the current point starfield, or null if disabled.">getPointStarfield</a> ()) {
<a name="l00418"></a>00418             <a class="code" href="classCaelum_1_1CaelumSystem.html#6ea428a5c3e12b04820eaad7accfd351" title="Gets the current point starfield, or null if disabled.">getPointStarfield</a> ()-&gt;<a class="code" href="classCaelum_1_1PointStarfield.html#02e0094f88bc80b87c9feb96971c7315" title="Handle camera change.">notifyCameraChanged</a> (cam);
<a name="l00419"></a>00419         }
<a name="l00420"></a>00420         
<a name="l00421"></a>00421         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#03f27d4962ac0eb8fedf5040bf2fa954" title="Get ground fog; if enabled.">getGroundFog</a> ()) {
<a name="l00422"></a>00422             <a class="code" href="classCaelum_1_1CaelumSystem.html#03f27d4962ac0eb8fedf5040bf2fa954" title="Get ground fog; if enabled.">getGroundFog</a> ()-&gt;<a class="code" href="classCaelum_1_1GroundFog.html#6673bc36dc01463a26865fa816eaa54c" title="Handle camera change.">notifyCameraChanged</a> (cam);
<a name="l00423"></a>00423         }
<a name="l00424"></a>00424     }
<a name="l00425"></a>00425                     
<a name="l00426"></a>00426     <span class="keywordtype">bool</span> CaelumSystem::frameStarted (<span class="keyword">const</span> Ogre::FrameEvent &amp;e) {
<a name="l00427"></a>00427         <span class="keywordflow">if</span> (mCleanup) {
<a name="l00428"></a>00428             <span class="comment">// Delayed destruction.</span>
<a name="l00429"></a>00429             mOgreRoot-&gt;removeFrameListener (<span class="keyword">this</span>);
<a name="l00430"></a>00430             <span class="keyword">delete</span> <span class="keyword">this</span>;
<a name="l00431"></a>00431             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00432"></a>00432         }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434         <a class="code" href="classCaelum_1_1CaelumSystem.html#da0592784d6cb26099144f735c1ba70a" title="Update the whole system manually.">updateSubcomponents</a>(e.timeSinceLastFrame);
<a name="l00435"></a>00435 
<a name="l00436"></a>00436         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00437"></a>00437     }
<a name="l00438"></a>00438 
<a name="l00439"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#da0592784d6cb26099144f735c1ba70a">00439</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#da0592784d6cb26099144f735c1ba70a" title="Update the whole system manually.">CaelumSystem::updateSubcomponents</a> (Real timeSinceLastFrame)
<a name="l00440"></a>00440     {
<a name="l00441"></a>00441         <span class="comment">/*</span>
<a name="l00442"></a>00442 <span class="comment">        LogManager::getSingleton().getDefaultLog()-&gt;logMessage(</span>
<a name="l00443"></a>00443 <span class="comment">                "CaelumSystem::updateSubcomponents: " +</span>
<a name="l00444"></a>00444 <span class="comment">                StringConverter::toString (timeSinceLastFrame, 10));</span>
<a name="l00445"></a>00445 <span class="comment">        */</span>
<a name="l00446"></a>00446 
<a name="l00447"></a>00447         mUniversalClock-&gt;update (timeSinceLastFrame);
<a name="l00448"></a>00448 
<a name="l00449"></a>00449         <span class="comment">// Timing variables</span>
<a name="l00450"></a>00450         LongReal julDay = mUniversalClock-&gt;getJulianDay ();
<a name="l00451"></a>00451         LongReal relDayTime = fmod(julDay, 1);
<a name="l00452"></a>00452         Real secondDiff = timeSinceLastFrame * mUniversalClock-&gt;getTimeScale ();
<a name="l00453"></a>00453 
<a name="l00454"></a>00454         <span class="comment">// Get astronomical parameters.</span>
<a name="l00455"></a>00455         Ogre::Vector3 sunDir = <a class="code" href="classCaelum_1_1CaelumSystem.html#95f8694c407aa696e5c9f329f1974513" title="Get the sun&amp;#39;s direction at a certain time.">getSunDirection</a>(julDay);    
<a name="l00456"></a>00456         Ogre::Vector3 moonDir = <a class="code" href="classCaelum_1_1CaelumSystem.html#8fff268cc6cd7919e1681da0f7742c4e" title="Get the moon&amp;#39;s direction at a certain time.">getMoonDirection</a>(julDay);  
<a name="l00457"></a>00457         Real moonPhase = <a class="code" href="classCaelum_1_1CaelumSystem.html#8ed333478c3aeea7d22aebbdd4264b3a" title="Fake function to get the phase of the moon.">getMoonPhase</a>(julDay);    
<a name="l00458"></a>00458 
<a name="l00459"></a>00459         <span class="comment">// Get parameters from sky colour model.</span>
<a name="l00460"></a>00460         Real fogDensity = <a class="code" href="classCaelum_1_1CaelumSystem.html#5d9a9cc3c5c9a4f32659aee83be5fae0" title="Gets the fog density for a certain daytime.">getFogDensity</a> (relDayTime, sunDir);           
<a name="l00461"></a>00461         Ogre::ColourValue fogColour = <a class="code" href="classCaelum_1_1CaelumSystem.html#7f1158511ce1937bb6d67acea1fea716" title="Gets the fog colour for a certain daytime.">getFogColour</a> (relDayTime, sunDir);                  
<a name="l00462"></a>00462         Ogre::ColourValue sunLightColour = <a class="code" href="classCaelum_1_1CaelumSystem.html#af4badcafc782e214db9e0963052c8c6" title="Gets the colour of sun light.">getSunLightColour</a> (relDayTime, sunDir);
<a name="l00463"></a>00463         Ogre::ColourValue sunSphereColour = <a class="code" href="classCaelum_1_1CaelumSystem.html#014ce75e3e5a641739ca2f52dcc789c0" title="Get the colour of the sun sphere.">getSunSphereColour</a> (relDayTime, sunDir);
<a name="l00464"></a>00464         Ogre::ColourValue moonLightColour = <a class="code" href="classCaelum_1_1CaelumSystem.html#79c9f24db306e0619d315b868c02e6fe" title="Gets the colour of moon&amp;#39;s light.">getMoonLightColour</a> (moonDir);
<a name="l00465"></a>00465         Ogre::ColourValue moonBodyColour = <a class="code" href="classCaelum_1_1CaelumSystem.html#d5f972d590e37e6f126678c2ded4a3ee" title="Gets the colour of moon&amp;#39;s body.">getMoonBodyColour</a> (moonDir); 
<a name="l00466"></a>00466 
<a name="l00467"></a>00467         fogDensity *= mGlobalFogDensityMultiplier;
<a name="l00468"></a>00468         fogColour = fogColour * mGlobalFogColourMultiplier;
<a name="l00469"></a>00469 
<a name="l00470"></a>00470         <span class="comment">// Update image starfield</span>
<a name="l00471"></a>00471         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#6cc93fd22454a9e01bfb1da7c45f5dc1" title="Gets the current image starfield, or null if disabled.">getImageStarfield</a> ()) {
<a name="l00472"></a>00472             <a class="code" href="classCaelum_1_1CaelumSystem.html#6cc93fd22454a9e01bfb1da7c45f5dc1" title="Gets the current image starfield, or null if disabled.">getImageStarfield</a> ()-&gt;<a class="code" href="classCaelum_1_1ImageStarfield.html#cc7dc18d33c727a3c8ea8832d4fe3b30" title="Updates the starfield position/orientation.">update</a> (relDayTime);
<a name="l00473"></a>00473             <a class="code" href="classCaelum_1_1CaelumSystem.html#6cc93fd22454a9e01bfb1da7c45f5dc1" title="Gets the current image starfield, or null if disabled.">getImageStarfield</a> ()-&gt;<a class="code" href="classCaelum_1_1ImageStarfield.html#24d3073fba11ce9301507954d2308e8a" title="Sets the starfield inclination.">setInclination</a> (-<a class="code" href="classCaelum_1_1CaelumSystem.html#c19a02f1b86e15bab21c2d8ac5b3fbd7" title="Get the observer&amp;#39;s latitude. North is positive, south is negative.">getObserverLatitude</a> ());
<a name="l00474"></a>00474         }
<a name="l00475"></a>00475 
<a name="l00476"></a>00476         <span class="comment">// Update point starfield</span>
<a name="l00477"></a>00477         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#6ea428a5c3e12b04820eaad7accfd351" title="Gets the current point starfield, or null if disabled.">getPointStarfield</a> ()) {
<a name="l00478"></a>00478             <a class="code" href="classCaelum_1_1CaelumSystem.html#6ea428a5c3e12b04820eaad7accfd351" title="Gets the current point starfield, or null if disabled.">getPointStarfield</a> ()-&gt;setObserverLatitude (<a class="code" href="classCaelum_1_1CaelumSystem.html#c19a02f1b86e15bab21c2d8ac5b3fbd7" title="Get the observer&amp;#39;s latitude. North is positive, south is negative.">getObserverLatitude</a> ());
<a name="l00479"></a>00479             <a class="code" href="classCaelum_1_1CaelumSystem.html#6ea428a5c3e12b04820eaad7accfd351" title="Gets the current point starfield, or null if disabled.">getPointStarfield</a> ()-&gt;setObserverLongitude (<a class="code" href="classCaelum_1_1CaelumSystem.html#42a54bea76373bc0a2895dc16a37a1a2" title="Get the observer&amp;#39;s longitude. East is positive, west is negative.">getObserverLongitude</a> ());
<a name="l00480"></a>00480             <a class="code" href="classCaelum_1_1CaelumSystem.html#6ea428a5c3e12b04820eaad7accfd351" title="Gets the current point starfield, or null if disabled.">getPointStarfield</a> ()-&gt;<a class="code" href="classCaelum_1_1PointStarfield.html#8c033a4c76b02bff453f71caa9e5e327" title="Update function; called from CaelumSystem::updateSubcomponents.">_update</a> (relDayTime);
<a name="l00481"></a>00481         }
<a name="l00482"></a>00482 
<a name="l00483"></a>00483         <span class="comment">// Update skydome.</span>
<a name="l00484"></a>00484         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#474c5e5fa66f551e168ab3cbf68df1a4" title="Get the current sky dome, or null if disabled.">getSkyDome</a> ()) {
<a name="l00485"></a>00485             <a class="code" href="classCaelum_1_1CaelumSystem.html#474c5e5fa66f551e168ab3cbf68df1a4" title="Get the current sky dome, or null if disabled.">getSkyDome</a> ()-&gt;<a class="code" href="classCaelum_1_1SkyDome.html#c0812bc3dd1f53d1638abfa2a4ba88e4" title="Sets the sun direction.">setSunDirection</a> (sunDir);
<a name="l00486"></a>00486             <a class="code" href="classCaelum_1_1CaelumSystem.html#474c5e5fa66f551e168ab3cbf68df1a4" title="Get the current sky dome, or null if disabled.">getSkyDome</a> ()-&gt;<a class="code" href="classCaelum_1_1SkyDome.html#f247f9e0dd37c654b01a850895bef5f7" title="Explicit haze colour.">setHazeColour</a> (fogColour * mSceneFogColourMultiplier);
<a name="l00487"></a>00487         }
<a name="l00488"></a>00488 
<a name="l00489"></a>00489         <span class="comment">// Update scene fog.</span>
<a name="l00490"></a>00490         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#2697cd76fa5970ea4f84940226f2d731" title="Tells if Caelum is managing the fog or not.">getManageSceneFog</a> ()) {
<a name="l00491"></a>00491             mSceneMgr-&gt;setFog (Ogre::FOG_EXP2,
<a name="l00492"></a>00492                     fogColour * mSceneFogColourMultiplier,
<a name="l00493"></a>00493                     fogDensity * mSceneFogDensityMultiplier);
<a name="l00494"></a>00494         }
<a name="l00495"></a>00495 
<a name="l00496"></a>00496         <span class="comment">// Update ground fog.</span>
<a name="l00497"></a>00497         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#03f27d4962ac0eb8fedf5040bf2fa954" title="Get ground fog; if enabled.">getGroundFog</a> ()) {
<a name="l00498"></a>00498             <a class="code" href="classCaelum_1_1CaelumSystem.html#03f27d4962ac0eb8fedf5040bf2fa954" title="Get ground fog; if enabled.">getGroundFog</a> ()-&gt;<a class="code" href="classCaelum_1_1GroundFog.html#280d152df3e6475e3ce30b50590f747b" title="Sets fog colour.">setColour</a> (fogColour * mGroundFogColourMultiplier);
<a name="l00499"></a>00499             <a class="code" href="classCaelum_1_1CaelumSystem.html#03f27d4962ac0eb8fedf5040bf2fa954" title="Get ground fog; if enabled.">getGroundFog</a> ()-&gt;<a class="code" href="classCaelum_1_1GroundFog.html#bd890eeb92a9905e7ac86a2f6ba36174" title="Sets the fog density multiplier.">setDensity</a> (fogDensity * mGroundFogDensityMultiplier);
<a name="l00500"></a>00500         }
<a name="l00501"></a>00501 
<a name="l00502"></a>00502         <span class="comment">// Update sun</span>
<a name="l00503"></a>00503         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#4ba1342732ff0dc1c81d4d0a037c7655" title="Gets the current sun, or null if disabled.">getSun</a> ()) {
<a name="l00504"></a>00504             mSun-&gt;update (sunDir, sunLightColour, sunSphereColour);
<a name="l00505"></a>00505         }
<a name="l00506"></a>00506 
<a name="l00507"></a>00507         <span class="comment">// Update moon.</span>
<a name="l00508"></a>00508         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#922127ba98ea3ec0524d2051d94e3ca8" title="Gets the current moon, or null if disabled.">getMoon</a> ()) {
<a name="l00509"></a>00509             mMoon-&gt;update (
<a name="l00510"></a>00510                     moonDir,
<a name="l00511"></a>00511                     moonLightColour,
<a name="l00512"></a>00512                     moonBodyColour);
<a name="l00513"></a>00513             mMoon-&gt;setPhase (moonPhase);
<a name="l00514"></a>00514         }
<a name="l00515"></a>00515 
<a name="l00516"></a>00516         <span class="comment">// Update clouds</span>
<a name="l00517"></a>00517         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#6668fcab69d92bbb65e23c78b73428c6" title="Get cloud system; or null if disabled.">getCloudSystem</a> ()) {
<a name="l00518"></a>00518             <a class="code" href="classCaelum_1_1CaelumSystem.html#6668fcab69d92bbb65e23c78b73428c6" title="Get cloud system; or null if disabled.">getCloudSystem</a> ()-&gt;<a class="code" href="classCaelum_1_1CloudSystem.html#008807a65ce227972dff3a326873e6a4" title="Update function called every frame from high above.">update</a> (
<a name="l00519"></a>00519                     secondDiff, sunDir, sunLightColour, fogColour, sunSphereColour);
<a name="l00520"></a>00520         }
<a name="l00521"></a>00521 
<a name="l00522"></a>00522         <span class="comment">// Update precipitation</span>
<a name="l00523"></a>00523         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#6a1d206466ff1d3513d39071e690c352" title="Get precipitation controller; or null if disabled.">getPrecipitationController</a> ()) {
<a name="l00524"></a>00524             <a class="code" href="classCaelum_1_1CaelumSystem.html#6a1d206466ff1d3513d39071e690c352" title="Get precipitation controller; or null if disabled.">getPrecipitationController</a> ()-&gt;<a class="code" href="classCaelum_1_1PrecipitationController.html#a80188225f379246802cf4504333f300" title="Update the the precipitation controller.">update</a> (secondDiff, fogColour);
<a name="l00525"></a>00525         }
<a name="l00526"></a>00526 
<a name="l00527"></a>00527         <span class="comment">// Update screen space fog</span>
<a name="l00528"></a>00528         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#f973506cf9495617323446f1ea35f6d3" title="Get depth composer; or null if disabled.">getDepthComposer</a> ()) {
<a name="l00529"></a>00529             <a class="code" href="classCaelum_1_1CaelumSystem.html#f973506cf9495617323446f1ea35f6d3" title="Get depth composer; or null if disabled.">getDepthComposer</a> ()-&gt;update ();
<a name="l00530"></a>00530             <a class="code" href="classCaelum_1_1CaelumSystem.html#f973506cf9495617323446f1ea35f6d3" title="Get depth composer; or null if disabled.">getDepthComposer</a> ()-&gt;setSunDirection (sunDir);
<a name="l00531"></a>00531             <a class="code" href="classCaelum_1_1CaelumSystem.html#f973506cf9495617323446f1ea35f6d3" title="Get depth composer; or null if disabled.">getDepthComposer</a> ()-&gt;setHazeColour (fogColour);
<a name="l00532"></a>00532             <a class="code" href="classCaelum_1_1CaelumSystem.html#f973506cf9495617323446f1ea35f6d3" title="Get depth composer; or null if disabled.">getDepthComposer</a> ()-&gt;<a class="code" href="classCaelum_1_1DepthComposer.html#497ef94d05a0bdbedd3f01da2d7f8d78" title="Sets ground fog colour.">setGroundFogColour</a> (fogColour * mGroundFogColourMultiplier);
<a name="l00533"></a>00533             <a class="code" href="classCaelum_1_1CaelumSystem.html#f973506cf9495617323446f1ea35f6d3" title="Get depth composer; or null if disabled.">getDepthComposer</a> ()-&gt;<a class="code" href="classCaelum_1_1DepthComposer.html#39eddd0ef5ab0f693ec8412b5e540b8c" title="Sets ground fog density.">setGroundFogDensity</a> (fogDensity * mGroundFogDensityMultiplier);
<a name="l00534"></a>00534         }
<a name="l00535"></a>00535 
<a name="l00536"></a>00536         <span class="comment">// Update ambient lighting.</span>
<a name="l00537"></a>00537         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#05785f1f82129112047e754ec11b734a" title="Check if CaelumSystem is managing ambient lighting.">getManageAmbientLight</a> ()) {
<a name="l00538"></a>00538             Ogre::ColourValue ambient = Ogre::ColourValue::Black;
<a name="l00539"></a>00539             <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#922127ba98ea3ec0524d2051d94e3ca8" title="Gets the current moon, or null if disabled.">getMoon</a> ()) {
<a name="l00540"></a>00540                 ambient += <a class="code" href="classCaelum_1_1CaelumSystem.html#922127ba98ea3ec0524d2051d94e3ca8" title="Gets the current moon, or null if disabled.">getMoon</a> ()-&gt;<a class="code" href="classCaelum_1_1BaseSkyLight.html#dee6ff3f029c346fab9f28fbb8ba6ea3" title="Get current light colour, as set in setLightColour.">getLightColour</a> () * <a class="code" href="classCaelum_1_1CaelumSystem.html#922127ba98ea3ec0524d2051d94e3ca8" title="Gets the current moon, or null if disabled.">getMoon</a> ()-&gt;<a class="code" href="classCaelum_1_1BaseSkyLight.html#cf7a6de766e821ccf549750a2af3eefb" title="Set ambient multiplier for light colour.">getAmbientMultiplier</a> ();
<a name="l00541"></a>00541             }
<a name="l00542"></a>00542             <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#4ba1342732ff0dc1c81d4d0a037c7655" title="Gets the current sun, or null if disabled.">getSun</a> ()) {
<a name="l00543"></a>00543                 ambient += <a class="code" href="classCaelum_1_1CaelumSystem.html#4ba1342732ff0dc1c81d4d0a037c7655" title="Gets the current sun, or null if disabled.">getSun</a> ()-&gt;<a class="code" href="classCaelum_1_1BaseSkyLight.html#dee6ff3f029c346fab9f28fbb8ba6ea3" title="Get current light colour, as set in setLightColour.">getLightColour</a> () * <a class="code" href="classCaelum_1_1CaelumSystem.html#4ba1342732ff0dc1c81d4d0a037c7655" title="Gets the current sun, or null if disabled.">getSun</a> ()-&gt;<a class="code" href="classCaelum_1_1BaseSkyLight.html#cf7a6de766e821ccf549750a2af3eefb" title="Set ambient multiplier for light colour.">getAmbientMultiplier</a> ();
<a name="l00544"></a>00544             }
<a name="l00545"></a>00545             ambient.r = std::max(ambient.r, mMinimumAmbientLight.r);
<a name="l00546"></a>00546             ambient.g = std::max(ambient.g, mMinimumAmbientLight.g);
<a name="l00547"></a>00547             ambient.b = std::max(ambient.b, mMinimumAmbientLight.b);
<a name="l00548"></a>00548             ambient.a = std::max(ambient.a, mMinimumAmbientLight.a);
<a name="l00549"></a>00549             <span class="comment">// Debug ambient factos (ick).</span>
<a name="l00550"></a>00550             <span class="comment">/*</span>
<a name="l00551"></a>00551 <span class="comment">            LogManager::getSingleton().logMessage (</span>
<a name="l00552"></a>00552 <span class="comment">                        "Sun is " + StringConverter::toString(sunLightColour) + "\n"</span>
<a name="l00553"></a>00553 <span class="comment">                        "Moon is " + StringConverter::toString(moonLightColour) + "\n"</span>
<a name="l00554"></a>00554 <span class="comment">                        "Ambient is " + StringConverter::toString(ambient) + "\n"</span>
<a name="l00555"></a>00555 <span class="comment">                        );</span>
<a name="l00556"></a>00556 <span class="comment">             */</span>
<a name="l00557"></a>00557             mSceneMgr-&gt;setAmbientLight (ambient);
<a name="l00558"></a>00558         }
<a name="l00559"></a>00559 
<a name="l00560"></a>00560         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#4ba1342732ff0dc1c81d4d0a037c7655" title="Gets the current sun, or null if disabled.">getSun</a>() &amp;&amp; <a class="code" href="classCaelum_1_1CaelumSystem.html#922127ba98ea3ec0524d2051d94e3ca8" title="Gets the current moon, or null if disabled.">getMoon</a> ()) {
<a name="l00561"></a>00561             Ogre::Real moonBrightness = moonLightColour.r + moonLightColour.g + moonLightColour.b + moonLightColour.a;
<a name="l00562"></a>00562             Ogre::Real sunBrightness = sunLightColour.r + sunLightColour.g + sunLightColour.b + sunLightColour.a;
<a name="l00563"></a>00563             <span class="keywordtype">bool</span> sunBrighterThanMoon = (sunBrightness &gt; moonBrightness);
<a name="l00564"></a>00564 
<a name="l00565"></a>00565             <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#d64b09cf5f8b91ab0c4fcaab1625e439" title="See setEnsureSingleLightSource.">getEnsureSingleLightSource</a> ()) {
<a name="l00566"></a>00566                 <a class="code" href="classCaelum_1_1CaelumSystem.html#922127ba98ea3ec0524d2051d94e3ca8" title="Gets the current moon, or null if disabled.">getMoon</a> ()-&gt;<a class="code" href="classCaelum_1_1BaseSkyLight.html#383e351155078645d297d03e1d5a81b8" title="Disable the light by force; without taking intensity into account.">setForceDisable</a> (sunBrighterThanMoon);
<a name="l00567"></a>00567                 <a class="code" href="classCaelum_1_1CaelumSystem.html#4ba1342732ff0dc1c81d4d0a037c7655" title="Gets the current sun, or null if disabled.">getSun</a> ()-&gt;<a class="code" href="classCaelum_1_1BaseSkyLight.html#383e351155078645d297d03e1d5a81b8" title="Disable the light by force; without taking intensity into account.">setForceDisable</a> (!sunBrighterThanMoon);
<a name="l00568"></a>00568             }
<a name="l00569"></a>00569             <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#c65cad2f909070ac8ac1eb899c5dd81f" title="See setEnsureSingleShadowSource.">getEnsureSingleShadowSource</a> ()) {
<a name="l00570"></a>00570                 <a class="code" href="classCaelum_1_1CaelumSystem.html#922127ba98ea3ec0524d2051d94e3ca8" title="Gets the current moon, or null if disabled.">getMoon</a> ()-&gt;<a class="code" href="classCaelum_1_1BaseSkyLight.html#ad76575548047269b583b6d0bc3279bd" title="Direct access to the Ogre::Light.">getMainLight</a> ()-&gt;setCastShadows (!sunBrighterThanMoon);
<a name="l00571"></a>00571                 <a class="code" href="classCaelum_1_1CaelumSystem.html#4ba1342732ff0dc1c81d4d0a037c7655" title="Gets the current sun, or null if disabled.">getSun</a> ()-&gt;<a class="code" href="classCaelum_1_1BaseSkyLight.html#ad76575548047269b583b6d0bc3279bd" title="Direct access to the Ogre::Light.">getMainLight</a> ()-&gt;setCastShadows (sunBrighterThanMoon);
<a name="l00572"></a>00572             }
<a name="l00573"></a>00573         }
<a name="l00574"></a>00574     }
<a name="l00575"></a>00575 
<a name="l00576"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#5124c2195ad84022300d5054c3a441d9">00576</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#5124c2195ad84022300d5054c3a441d9" title="Enables/disables Caelum managing standard Ogre::Scene fog.">CaelumSystem::setManageSceneFog</a> (<span class="keywordtype">bool</span> value) {
<a name="l00577"></a>00577         mManageSceneFog = value;
<a name="l00578"></a>00578         <span class="comment">// Prevent having some stale values around.</span>
<a name="l00579"></a>00579         <span class="keywordflow">if</span> (!value) {
<a name="l00580"></a>00580             mSceneMgr-&gt;setFog (Ogre::FOG_NONE);
<a name="l00581"></a>00581         }
<a name="l00582"></a>00582     }
<a name="l00583"></a>00583 
<a name="l00584"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#2697cd76fa5970ea4f84940226f2d731">00584</a>     <span class="keywordtype">bool</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#2697cd76fa5970ea4f84940226f2d731" title="Tells if Caelum is managing the fog or not.">CaelumSystem::getManageSceneFog</a> ()<span class="keyword"> const </span>{
<a name="l00585"></a>00585         <span class="keywordflow">return</span> mManageSceneFog;
<a name="l00586"></a>00586     }
<a name="l00587"></a>00587 
<a name="l00588"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#614b5aa70e9ab3f05e9d0352591ebd91">00588</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#614b5aa70e9ab3f05e9d0352591ebd91" title="Multiplier for scene fog density (default 1).">CaelumSystem::setSceneFogDensityMultiplier</a> (Real value) {
<a name="l00589"></a>00589         mSceneFogDensityMultiplier = value;
<a name="l00590"></a>00590     }
<a name="l00591"></a>00591 
<a name="l00592"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#c4f97d7338980ee799e242a8ddd587bc">00592</a>     Real <a class="code" href="classCaelum_1_1CaelumSystem.html#c4f97d7338980ee799e242a8ddd587bc" title="Get the value set by setSceneFogDensityMultiplier.">CaelumSystem::getSceneFogDensityMultiplier</a> ()<span class="keyword"> const </span>{
<a name="l00593"></a>00593         <span class="keywordflow">return</span> mSceneFogDensityMultiplier;
<a name="l00594"></a>00594     }
<a name="l00595"></a>00595 
<a name="l00596"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#e8bc4e466f086edb86e797b255e09fa9">00596</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#e8bc4e466f086edb86e797b255e09fa9" title="Multiplier for ground fog density (default 1).">CaelumSystem::setGroundFogDensityMultiplier</a> (Real value) {
<a name="l00597"></a>00597         mGroundFogDensityMultiplier = value;
<a name="l00598"></a>00598     }
<a name="l00599"></a>00599 
<a name="l00600"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#d88f9996a7becdec1dcc1e57ac9c81fa">00600</a>     Real <a class="code" href="classCaelum_1_1CaelumSystem.html#d88f9996a7becdec1dcc1e57ac9c81fa" title="Get the value set by setGroundFogDensityMultiplier.">CaelumSystem::getGroundFogDensityMultiplier</a> ()<span class="keyword"> const </span>{
<a name="l00601"></a>00601         <span class="keywordflow">return</span> mGroundFogDensityMultiplier;
<a name="l00602"></a>00602     }
<a name="l00603"></a>00603 
<a name="l00604"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#bbaf90cc5df3445487ca5744d54a4987">00604</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#bbaf90cc5df3445487ca5744d54a4987" title="Multiplier for global fog density (default 1).">CaelumSystem::setGlobalFogDensityMultiplier</a> (Real value) {
<a name="l00605"></a>00605         mGlobalFogDensityMultiplier = value;
<a name="l00606"></a>00606     }
<a name="l00607"></a>00607 
<a name="l00608"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#13e1c9eb6a45894ae3e3065792f5bd69">00608</a>     Real <a class="code" href="classCaelum_1_1CaelumSystem.html#13e1c9eb6a45894ae3e3065792f5bd69" title="Get the value set by setSceneFogDensityMultiplier.">CaelumSystem::getGlobalFogDensityMultiplier</a> ()<span class="keyword"> const </span>{
<a name="l00609"></a>00609         <span class="keywordflow">return</span> mGlobalFogDensityMultiplier;
<a name="l00610"></a>00610     }
<a name="l00611"></a>00611 
<a name="l00612"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#80f9fc6389880cba376799b8a1e7c0e0">00612</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#80f9fc6389880cba376799b8a1e7c0e0" title="Set the sun gradients image.">CaelumSystem::setSkyGradientsImage</a> (<span class="keyword">const</span> Ogre::String &amp;filename) {
<a name="l00613"></a>00613         mSkyGradientsImage.reset(<span class="keyword">new</span> Ogre::Image ());
<a name="l00614"></a>00614         mSkyGradientsImage-&gt;load (filename, RESOURCE_GROUP_NAME);
<a name="l00615"></a>00615     }
<a name="l00616"></a>00616 
<a name="l00617"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#2c646e7a27f7d819b2ae9bd5490962e0">00617</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#2c646e7a27f7d819b2ae9bd5490962e0" title="Set the sun colours image.">CaelumSystem::setSunColoursImage</a> (<span class="keyword">const</span> Ogre::String &amp;filename) {
<a name="l00618"></a>00618         mSunColoursImage.reset(<span class="keyword">new</span> Ogre::Image ());
<a name="l00619"></a>00619         mSunColoursImage-&gt;load (filename, RESOURCE_GROUP_NAME);
<a name="l00620"></a>00620     }
<a name="l00621"></a>00621 
<a name="l00622"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#7f1158511ce1937bb6d67acea1fea716">00622</a>     Ogre::ColourValue <a class="code" href="classCaelum_1_1CaelumSystem.html#7f1158511ce1937bb6d67acea1fea716" title="Gets the fog colour for a certain daytime.">CaelumSystem::getFogColour</a> (Real time, <span class="keyword">const</span> Ogre::Vector3 &amp;sunDir) {
<a name="l00623"></a>00623         <span class="keywordflow">if</span> (!mSkyGradientsImage.get()) {
<a name="l00624"></a>00624             <span class="keywordflow">return</span> Ogre::ColourValue::Black;
<a name="l00625"></a>00625         }
<a name="l00626"></a>00626 
<a name="l00627"></a>00627         Real elevation = sunDir.dotProduct (Ogre::Vector3::UNIT_Y) * 0.5 + 0.5;
<a name="l00628"></a>00628         Ogre::ColourValue col = <a class="code" href="classCaelum_1_1InternalUtilities.html#c37ccc30dfd0429dafa5923f879438de" title="Gets the interpolated colour between two pixels from an image.">InternalUtilities::getInterpolatedColour</a> (elevation, 1, mSkyGradientsImage.get(), <span class="keyword">false</span>);
<a name="l00629"></a>00629         <span class="keywordflow">return</span> col;
<a name="l00630"></a>00630     }
<a name="l00631"></a>00631 
<a name="l00632"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#5d9a9cc3c5c9a4f32659aee83be5fae0">00632</a>     Real <a class="code" href="classCaelum_1_1CaelumSystem.html#5d9a9cc3c5c9a4f32659aee83be5fae0" title="Gets the fog density for a certain daytime.">CaelumSystem::getFogDensity</a> (Real time, <span class="keyword">const</span> Ogre::Vector3 &amp;sunDir)
<a name="l00633"></a>00633     {
<a name="l00634"></a>00634         <span class="keywordflow">if</span> (!mSkyGradientsImage.get()) {
<a name="l00635"></a>00635             <span class="keywordflow">return</span> 0;
<a name="l00636"></a>00636         }
<a name="l00637"></a>00637 
<a name="l00638"></a>00638         Real elevation = sunDir.dotProduct (Ogre::Vector3::UNIT_Y) * 0.5 + 0.5;
<a name="l00639"></a>00639         Ogre::ColourValue col = <a class="code" href="classCaelum_1_1InternalUtilities.html#c37ccc30dfd0429dafa5923f879438de" title="Gets the interpolated colour between two pixels from an image.">InternalUtilities::getInterpolatedColour</a> (elevation, 1, mSkyGradientsImage.get(), <span class="keyword">false</span>);
<a name="l00640"></a>00640         <span class="keywordflow">return</span> col.a;
<a name="l00641"></a>00641     }
<a name="l00642"></a>00642 
<a name="l00643"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#014ce75e3e5a641739ca2f52dcc789c0">00643</a>     Ogre::ColourValue <a class="code" href="classCaelum_1_1CaelumSystem.html#014ce75e3e5a641739ca2f52dcc789c0" title="Get the colour of the sun sphere.">CaelumSystem::getSunSphereColour</a> (Real time, <span class="keyword">const</span> Ogre::Vector3 &amp;sunDir)
<a name="l00644"></a>00644     {
<a name="l00645"></a>00645         <span class="keywordflow">if</span> (!mSunColoursImage.get()) {
<a name="l00646"></a>00646             <span class="keywordflow">return</span> Ogre::ColourValue::White;
<a name="l00647"></a>00647         }
<a name="l00648"></a>00648 
<a name="l00649"></a>00649         Real elevation = sunDir.dotProduct (Ogre::Vector3::UNIT_Y);
<a name="l00650"></a>00650         elevation = elevation * 2 + 0.4;
<a name="l00651"></a>00651         <span class="keywordflow">return</span> <a class="code" href="classCaelum_1_1InternalUtilities.html#c37ccc30dfd0429dafa5923f879438de" title="Gets the interpolated colour between two pixels from an image.">InternalUtilities::getInterpolatedColour</a> (elevation, 1, mSunColoursImage.get(), <span class="keyword">false</span>);
<a name="l00652"></a>00652     }
<a name="l00653"></a>00653 
<a name="l00654"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#af4badcafc782e214db9e0963052c8c6">00654</a>     Ogre::ColourValue <a class="code" href="classCaelum_1_1CaelumSystem.html#af4badcafc782e214db9e0963052c8c6" title="Gets the colour of sun light.">CaelumSystem::getSunLightColour</a> (Real time, <span class="keyword">const</span> Ogre::Vector3 &amp;sunDir)
<a name="l00655"></a>00655     {
<a name="l00656"></a>00656         <span class="keywordflow">if</span> (!mSkyGradientsImage.get()) {
<a name="l00657"></a>00657             exit(-1);
<a name="l00658"></a>00658             <span class="keywordflow">return</span> Ogre::ColourValue::White;
<a name="l00659"></a>00659         }
<a name="l00660"></a>00660         Real elevation = sunDir.dotProduct (Ogre::Vector3::UNIT_Y) * 0.5 + 0.5;
<a name="l00661"></a>00661 
<a name="l00662"></a>00662         <span class="comment">// Hack: return averaged sky colours.</span>
<a name="l00663"></a>00663         <span class="comment">// Don't use an alpha value for lights, this can cause nasty problems.</span>
<a name="l00664"></a>00664         Ogre::ColourValue col = <a class="code" href="classCaelum_1_1InternalUtilities.html#c37ccc30dfd0429dafa5923f879438de" title="Gets the interpolated colour between two pixels from an image.">InternalUtilities::getInterpolatedColour</a> (elevation, elevation, mSkyGradientsImage.get(), <span class="keyword">false</span>);
<a name="l00665"></a>00665         Real val = (col.r + col.g + col.b) / 3;
<a name="l00666"></a>00666         col = Ogre::ColourValue(val, val, val, 1.0);
<a name="l00667"></a>00667         assert(Ogre::Math::RealEqual(col.a, 1));
<a name="l00668"></a>00668         <span class="keywordflow">return</span> col;
<a name="l00669"></a>00669     }
<a name="l00670"></a>00670 
<a name="l00671"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#d5f972d590e37e6f126678c2ded4a3ee">00671</a>     Ogre::ColourValue <a class="code" href="classCaelum_1_1CaelumSystem.html#d5f972d590e37e6f126678c2ded4a3ee" title="Gets the colour of moon&amp;#39;s body.">CaelumSystem::getMoonBodyColour</a> (<span class="keyword">const</span> Ogre::Vector3 &amp;moonDir) {
<a name="l00672"></a>00672         <span class="keywordflow">return</span> Ogre::ColourValue::White;
<a name="l00673"></a>00673     }
<a name="l00674"></a>00674 
<a name="l00675"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#79c9f24db306e0619d315b868c02e6fe">00675</a>     Ogre::ColourValue <a class="code" href="classCaelum_1_1CaelumSystem.html#79c9f24db306e0619d315b868c02e6fe" title="Gets the colour of moon&amp;#39;s light.">CaelumSystem::getMoonLightColour</a> (<span class="keyword">const</span> Ogre::Vector3 &amp;moonDir)
<a name="l00676"></a>00676     {
<a name="l00677"></a>00677         <span class="keywordflow">if</span> (!mSkyGradientsImage.get()) {
<a name="l00678"></a>00678             <span class="keywordflow">return</span> Ogre::ColourValue::Blue;
<a name="l00679"></a>00679         }
<a name="l00680"></a>00680         <span class="comment">// Scaled version of getSunLightColor</span>
<a name="l00681"></a>00681         Real elevation = moonDir.dotProduct (Ogre::Vector3::UNIT_Y) * 0.5 + 0.5;
<a name="l00682"></a>00682         Ogre::ColourValue col = <a class="code" href="classCaelum_1_1InternalUtilities.html#c37ccc30dfd0429dafa5923f879438de" title="Gets the interpolated colour between two pixels from an image.">InternalUtilities::getInterpolatedColour</a> (elevation, elevation, mSkyGradientsImage.get(), <span class="keyword">false</span>);
<a name="l00683"></a>00683         Real val = (col.r + col.g + col.b) / 3;
<a name="l00684"></a>00684         col = Ogre::ColourValue(val / 2.5f, val / 2.5f, val / 2.5f, 1.0);
<a name="l00685"></a>00685         assert(Ogre::Math::RealEqual(col.a, 1));
<a name="l00686"></a>00686         <span class="keywordflow">return</span> col;
<a name="l00687"></a>00687     }
<a name="l00688"></a>00688 
<a name="l00689"></a>00689     <span class="keyword">const</span> Ogre::Vector3 CaelumSystem::makeDirection (
<a name="l00690"></a>00690             Ogre::Degree azimuth, Ogre::Degree altitude)
<a name="l00691"></a>00691     {
<a name="l00692"></a>00692         Ogre::Vector3 res;
<a name="l00693"></a>00693         res.z = -Ogre::Math::Cos (azimuth) * Ogre::Math::Cos (altitude);  <span class="comment">// North </span>
<a name="l00694"></a>00694         res.x =  Ogre::Math::Sin (azimuth) * Ogre::Math::Cos (altitude);  <span class="comment">// East</span>
<a name="l00695"></a>00695         res.y = -Ogre::Math::Sin (altitude); <span class="comment">// Zenith</span>
<a name="l00696"></a>00696         <span class="keywordflow">return</span> res;
<a name="l00697"></a>00697     }
<a name="l00698"></a>00698 
<a name="l00699"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#95f8694c407aa696e5c9f329f1974513">00699</a>     <span class="keyword">const</span> Ogre::Vector3 <a class="code" href="classCaelum_1_1CaelumSystem.html#95f8694c407aa696e5c9f329f1974513" title="Get the sun&amp;#39;s direction at a certain time.">CaelumSystem::getSunDirection</a> (LongReal jday)
<a name="l00700"></a>00700     {
<a name="l00701"></a>00701         Ogre::Degree azimuth, altitude;
<a name="l00702"></a>00702         {
<a name="l00703"></a>00703             <a class="code" href="classCaelum_1_1ScopedHighPrecissionFloatSwitch.html" title="Dummy class to increase floting point precission in a block This class will raise...">ScopedHighPrecissionFloatSwitch</a> precissionSwitch;
<a name="l00704"></a>00704                               
<a name="l00705"></a>00705             <a class="code" href="classCaelum_1_1Astronomy.html#3ccbbbab71c3849783ee5799533bb245" title="Get the sun&amp;#39;s position in the sky in, relative to the horizon.">Astronomy::getHorizontalSunPosition</a>(jday,
<a name="l00706"></a>00706                     <a class="code" href="classCaelum_1_1CaelumSystem.html#42a54bea76373bc0a2895dc16a37a1a2" title="Get the observer&amp;#39;s longitude. East is positive, west is negative.">getObserverLongitude</a>(), <a class="code" href="classCaelum_1_1CaelumSystem.html#c19a02f1b86e15bab21c2d8ac5b3fbd7" title="Get the observer&amp;#39;s latitude. North is positive, south is negative.">getObserverLatitude</a>(),
<a name="l00707"></a>00707                     azimuth, altitude);     
<a name="l00708"></a>00708         }
<a name="l00709"></a>00709         Ogre::Vector3 res = makeDirection(azimuth, altitude);
<a name="l00710"></a>00710 
<a name="l00711"></a>00711         <span class="keywordflow">return</span> res;
<a name="l00712"></a>00712     }
<a name="l00713"></a>00713 
<a name="l00714"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#8fff268cc6cd7919e1681da0f7742c4e">00714</a>     <span class="keyword">const</span> Ogre::Vector3 <a class="code" href="classCaelum_1_1CaelumSystem.html#8fff268cc6cd7919e1681da0f7742c4e" title="Get the moon&amp;#39;s direction at a certain time.">CaelumSystem::getMoonDirection</a> (LongReal jday)
<a name="l00715"></a>00715     {
<a name="l00716"></a>00716         Ogre::Degree azimuth, altitude;
<a name="l00717"></a>00717         {
<a name="l00718"></a>00718             <a class="code" href="classCaelum_1_1ScopedHighPrecissionFloatSwitch.html" title="Dummy class to increase floting point precission in a block This class will raise...">ScopedHighPrecissionFloatSwitch</a> precissionSwitch;
<a name="l00719"></a>00719 
<a name="l00720"></a>00720             Astronomy::getHorizontalMoonPosition(jday,
<a name="l00721"></a>00721                     <a class="code" href="classCaelum_1_1CaelumSystem.html#42a54bea76373bc0a2895dc16a37a1a2" title="Get the observer&amp;#39;s longitude. East is positive, west is negative.">getObserverLongitude</a> (), <a class="code" href="classCaelum_1_1CaelumSystem.html#c19a02f1b86e15bab21c2d8ac5b3fbd7" title="Get the observer&amp;#39;s latitude. North is positive, south is negative.">getObserverLatitude</a> (),
<a name="l00722"></a>00722                     azimuth, altitude);
<a name="l00723"></a>00723         }   
<a name="l00724"></a>00724         Ogre::Vector3 res = makeDirection(azimuth, altitude);
<a name="l00725"></a>00725 
<a name="l00726"></a>00726         <span class="keywordflow">return</span> res;
<a name="l00727"></a>00727     }
<a name="l00728"></a>00728 
<a name="l00729"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#8ed333478c3aeea7d22aebbdd4264b3a">00729</a>     <span class="keyword">const</span> Ogre::Real <a class="code" href="classCaelum_1_1CaelumSystem.html#8ed333478c3aeea7d22aebbdd4264b3a" title="Fake function to get the phase of the moon.">CaelumSystem::getMoonPhase</a> (LongReal jday)
<a name="l00730"></a>00730     {
<a name="l00731"></a>00731         <span class="comment">// Calculates julian days since January 22, 2008 13:36 (full moon)</span>
<a name="l00732"></a>00732         <span class="comment">// and divides by the time between lunations (synodic month)</span>
<a name="l00733"></a>00733         LongReal T = (jday - 2454488.0665L) / 29.531026L;
<a name="l00734"></a>00734 
<a name="l00735"></a>00735         T = fabs(fmod(T, 1));
<a name="l00736"></a>00736         <span class="keywordflow">return</span> -fabs(-4 * T + 2) + 2;
<a name="l00737"></a>00737     }
<a name="l00738"></a>00738 
<a name="l00739"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#76ec83de3de7c94472b479ea7a5064b0">00739</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#76ec83de3de7c94472b479ea7a5064b0" title="Call setQueryFlags for all subcomponents now.">CaelumSystem::forceSubcomponentQueryFlags</a> (uint flags)
<a name="l00740"></a>00740     {
<a name="l00741"></a>00741         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#474c5e5fa66f551e168ab3cbf68df1a4" title="Get the current sky dome, or null if disabled.">getSkyDome</a> ()) <a class="code" href="classCaelum_1_1CaelumSystem.html#474c5e5fa66f551e168ab3cbf68df1a4" title="Get the current sky dome, or null if disabled.">getSkyDome</a> ()-&gt;setQueryFlags (flags);
<a name="l00742"></a>00742         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#4ba1342732ff0dc1c81d4d0a037c7655" title="Gets the current sun, or null if disabled.">getSun</a> ()) <a class="code" href="classCaelum_1_1CaelumSystem.html#4ba1342732ff0dc1c81d4d0a037c7655" title="Gets the current sun, or null if disabled.">getSun</a> ()-&gt;setQueryFlags (flags);
<a name="l00743"></a>00743         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#922127ba98ea3ec0524d2051d94e3ca8" title="Gets the current moon, or null if disabled.">getMoon</a> ()) <a class="code" href="classCaelum_1_1CaelumSystem.html#922127ba98ea3ec0524d2051d94e3ca8" title="Gets the current moon, or null if disabled.">getMoon</a> ()-&gt;setQueryFlags (flags);
<a name="l00744"></a>00744         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#6cc93fd22454a9e01bfb1da7c45f5dc1" title="Gets the current image starfield, or null if disabled.">getImageStarfield</a> ()) <a class="code" href="classCaelum_1_1CaelumSystem.html#6cc93fd22454a9e01bfb1da7c45f5dc1" title="Gets the current image starfield, or null if disabled.">getImageStarfield</a> ()-&gt;setQueryFlags (flags);
<a name="l00745"></a>00745         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#6ea428a5c3e12b04820eaad7accfd351" title="Gets the current point starfield, or null if disabled.">getPointStarfield</a> ()) <a class="code" href="classCaelum_1_1CaelumSystem.html#6ea428a5c3e12b04820eaad7accfd351" title="Gets the current point starfield, or null if disabled.">getPointStarfield</a> ()-&gt;setQueryFlags (flags);        
<a name="l00746"></a>00746         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#03f27d4962ac0eb8fedf5040bf2fa954" title="Get ground fog; if enabled.">getGroundFog</a> ()) <a class="code" href="classCaelum_1_1CaelumSystem.html#03f27d4962ac0eb8fedf5040bf2fa954" title="Get ground fog; if enabled.">getGroundFog</a> ()-&gt;setQueryFlags (flags);
<a name="l00747"></a>00747         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#6668fcab69d92bbb65e23c78b73428c6" title="Get cloud system; or null if disabled.">getCloudSystem</a> ()) <a class="code" href="classCaelum_1_1CaelumSystem.html#6668fcab69d92bbb65e23c78b73428c6" title="Get cloud system; or null if disabled.">getCloudSystem</a> ()-&gt;<a class="code" href="classCaelum_1_1CloudSystem.html#bb4f059a00d840214381d8cd5c39c7a5" title="Similar to.">forceLayerQueryFlags</a> (flags);
<a name="l00748"></a>00748     }
<a name="l00749"></a>00749 
<a name="l00750"></a><a class="code" href="classCaelum_1_1CaelumSystem.html#ba5f6cb695caf44ff5349b37546b164d">00750</a>     <span class="keywordtype">void</span> <a class="code" href="classCaelum_1_1CaelumSystem.html#ba5f6cb695caf44ff5349b37546b164d" title="Same as.">CaelumSystem::forceSubcomponentVisibilityFlags</a> (uint flags)
<a name="l00751"></a>00751     {
<a name="l00752"></a>00752         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#474c5e5fa66f551e168ab3cbf68df1a4" title="Get the current sky dome, or null if disabled.">getSkyDome</a> ()) <a class="code" href="classCaelum_1_1CaelumSystem.html#474c5e5fa66f551e168ab3cbf68df1a4" title="Get the current sky dome, or null if disabled.">getSkyDome</a> ()-&gt;setVisibilityFlags (flags);
<a name="l00753"></a>00753         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#4ba1342732ff0dc1c81d4d0a037c7655" title="Gets the current sun, or null if disabled.">getSun</a> ()) <a class="code" href="classCaelum_1_1CaelumSystem.html#4ba1342732ff0dc1c81d4d0a037c7655" title="Gets the current sun, or null if disabled.">getSun</a> ()-&gt;setVisibilityFlags (flags);
<a name="l00754"></a>00754         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#922127ba98ea3ec0524d2051d94e3ca8" title="Gets the current moon, or null if disabled.">getMoon</a> ()) <a class="code" href="classCaelum_1_1CaelumSystem.html#922127ba98ea3ec0524d2051d94e3ca8" title="Gets the current moon, or null if disabled.">getMoon</a> ()-&gt;setVisibilityFlags (flags);
<a name="l00755"></a>00755         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#6cc93fd22454a9e01bfb1da7c45f5dc1" title="Gets the current image starfield, or null if disabled.">getImageStarfield</a> ()) <a class="code" href="classCaelum_1_1CaelumSystem.html#6cc93fd22454a9e01bfb1da7c45f5dc1" title="Gets the current image starfield, or null if disabled.">getImageStarfield</a> ()-&gt;setVisibilityFlags (flags);
<a name="l00756"></a>00756         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#6ea428a5c3e12b04820eaad7accfd351" title="Gets the current point starfield, or null if disabled.">getPointStarfield</a> ()) <a class="code" href="classCaelum_1_1CaelumSystem.html#6ea428a5c3e12b04820eaad7accfd351" title="Gets the current point starfield, or null if disabled.">getPointStarfield</a> ()-&gt;setVisibilityFlags (flags);        
<a name="l00757"></a>00757         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#03f27d4962ac0eb8fedf5040bf2fa954" title="Get ground fog; if enabled.">getGroundFog</a> ()) <a class="code" href="classCaelum_1_1CaelumSystem.html#03f27d4962ac0eb8fedf5040bf2fa954" title="Get ground fog; if enabled.">getGroundFog</a> ()-&gt;setVisibilityFlags (flags);
<a name="l00758"></a>00758         <span class="keywordflow">if</span> (<a class="code" href="classCaelum_1_1CaelumSystem.html#6668fcab69d92bbb65e23c78b73428c6" title="Get cloud system; or null if disabled.">getCloudSystem</a> ()) <a class="code" href="classCaelum_1_1CaelumSystem.html#6668fcab69d92bbb65e23c78b73428c6" title="Get cloud system; or null if disabled.">getCloudSystem</a> ()-&gt;<a class="code" href="classCaelum_1_1CloudSystem.html#7bc713d60c3776258472d27eb64ee89d" title="Similar to.">forceLayerVisibilityFlags</a> (flags);
<a name="l00759"></a>00759     }
<a name="l00760"></a>00760 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Sun Aug 9 10:48:55 2009 for Caelum by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.9 </small></address>
</body>
</html>
